<html>
  <head>
    <title>Viewholder中为什么要使用SparseArray对View进行存储？ - SmartNi</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='/atom.xml' rel='alternate' type='application/rss+xml'>
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/responsive.css">
<link rel="stylesheet" href="/css/syntax.css">
<script src="/js/jquery.js"></script>
<script src="/js/basics.js"></script>
<script src="/js/pd.js"></script>
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type'>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-102765380-1');
  ga('send', 'pageview');
</script>



  </head>
  <body>
    <header>
    <a id='go-back-home' href='/'><img src='/images/scribble.png' alt='Home' width='66' height='66'></a>
    <p>
        SmartNi
    </p>
    <p>
        做好每一件小事！
    </p>
    
	<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/androidstudio.min.css">
	<script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <!-- gruvbox-dark  ,monokai-sublime,zenburn -->
<!-- railscasts   mono-blue  tomorrow  androidstudio  monokai-->
	<script>hljs.initHighlightingOnLoad();</script>
  
   
    <style type="text/css">
    object,
    embed {
        -webkit-animation-duration: .001s;
        -webkit-animation-name: playerInserted;
        -ms-animation-duration: .001s;
        -ms-animation-name: playerInserted;
        -o-animation-duration: .001s;
        -o-animation-name: playerInserted;
        animation-duration: .001s;
        animation-name: playerInserted;
    }

    @-webkit-keyframes playerInserted {
        from {
            opacity: 0.99;
        }
        to {
            opacity: 1;
        }
    }

    @-ms-keyframes playerInserted {
        from {
            opacity: 0.99;
        }
        to {
            opacity: 1;
        }
    }

    @-o-keyframes playerInserted {
        from {
            opacity: 0.99;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes playerInserted {
        from {
            opacity: 0.99;
        }
        to {
            opacity: 1;
        }
    }
    </style>
</header>
    <div id='container'>
      <div class='block'>
  
    <a class='main' href='/'>Home</a>
  
    <a class='main' href='/about'>About</a>
  
    <a class='main' href='mailto:nijun717@gmail.com'>Email</a>
  
    <a class='main' href='https://github.com/SmartNJ'>Github</a>
  
</div>

      <!-- <section class='paging'>
  
  
    <div class='right'>
      <a href='/2017/07/30/encapsulation-inheritance-polymorphism/'>
        ›
      </a>
    </div>
  
</section>
  左右箭头 -->
      <div class='content'>
        <section class='post'>
          <h1>
            <!-- <div class='date'>2017-08-04</div>  日期 -->
            Viewholder中为什么要使用SparseArray对View进行存储？
          </h1>
          <p>最近项目时，设计 ViewHolder 时用到了 SparseArray，为什么一定要用这个呢？ SparseArray 有什么优点吗？</p>
<p>private SparseArray<view> mViews; </view></p>
<p>使用SparseArray保存View。</p>
<p> SparseArray 比 HashMap更省内存。为什么？</p>
<p>参考：<a href="http://blog.csdn.net/u010687392/article/details/47809295" target="_blank" rel="external">http://blog.csdn.net/u010687392/article/details/47809295</a></p>
<a id="more"></a>
<hr>
<h1 id="Hashmap"><a href="#Hashmap" class="headerlink" title="Hashmap"></a>Hashmap</h1><p>Hashmap内部默认使用一个容量16的数组来存储数据，而数组中每个元素又是一个链表的头结点。也就是说，Hashmap内部是使用哈希表的拉链结构（数组+链表），也叫做拉链法：</p>
<p><img src="http://osoa5juml.bkt.clouddn.com/image/site/1501826801083.png" width="528"></p>
<p>每个结点是一个Entry，Entry的内部的属性：</p>
<pre><code>final K key; 

V value; 

final int hash; 

HashMapEntry&lt;K, V&gt; next;
</code></pre><p>这些Entry数据是按什么规则进行存储的？</p>
<p>通过key计算hash值，然后对HashMap中的数组长度取余得到该元素的存储位置，  hash(key) % len。</p>
<p>拉链法解决了元素冲突的问题，后一个元素不会覆盖前一个元素。</p>
<p>解决hash冲突的方法还有：</p>
<p>1、开放地址法</p>
<p>2、再哈希法</p>
<p>3、链地址法</p>
<p>4、建立公共溢出区</p>
<p>HashMap的默认容量是16，我们创建一个新的HashMap，即使里面没有数据，也会占用16个数据的内存。如果不断往里面put东西，容量到达一个值时就会扩容，这个值怎么算？  答 ：当前容量 * 加载因子（HashMap默认是0.75）。 根据源码，它一定会扩大为原来的两倍。</p>
<pre><code>int newCapacity = oldCapacity * 2;
</code></pre><p>所以说，只要满足条件就会扩容，如果数据量很大，就需要不算扩容（而且是2倍），加上计算hash值的消耗，会对内存空间造成很大的消耗和浪费。</p>
<p>HashMap是通过遍历entry[]数组来得到对应的元素，数据量一大就会比较慢。</p>
<h1 id="SparseArray"><a href="#SparseArray" class="headerlink" title="SparseArray"></a>SparseArray</h1><p>SparseArray能避免对key的自动装箱（比如 int 转为 Integer），内部是通过两个数组来存储数据。注意这里key只能是int类型的。</p>
<pre><code>private int[] mKeys; 

private Object[] mValues;
</code></pre><p>SparseArray在读取和存放数据的时候，是使用二分查找法</p>
<pre><code>public void put(int key, E value) {
      int i = ContainerHelpers.binarySearch(mKeys, mSize, key); 
      … 
} 
public E get(int key, E valueIfKeyNotFound) {
      int i = ContainerHelpers.binarySearch(mKeys, mSize, key); 
      … 
}
</code></pre><p>Put的时候会使用二分查找法，对当前添加的元素和之前已添加的元素的key进行比较，然后从小到大排序。所以SparseArray存储的元素都是按元素的key值从小到大排序好的。</p>
<p>获取的时候也使用二分查找法，比HashMap快得多，HashMap是通过遍历entry数组来获取元素的。</p>
<p>添加数据</p>
<pre><code>public void put(int key, E value)
</code></pre><p>删除数据</p>
<pre><code>public void remove(int key)
</code></pre><p>或者</p>
<pre><code>public void delete(int key)
</code></pre><p>remove内部就是调用delete来删除的。</p>
<p>获取数据</p>
<pre><code>public E get(int key)
</code></pre><p>或者</p>
<pre><code>public E get(int key, E valueIfKeyNotFound)
</code></pre><p>如果key不存在就会返回valueIfKeyNotFound。</p>
<p>特有方法</p>
<pre><code>public int keyAt(int index)

和

public E valueAt(int index)
</code></pre><p>SparseArray      应用场景<br>虽说SparseArray的性能比较好，但是由于每次增加、修改、删除都需要进行一个二分查找，所以一旦数据量大了，性能提升的并不明显，降低至少50%。</p>
<p>满足下面两个条件我们可以使用SparseArray代替HashMap：</p>
<ul>
<li>数据量不大，最好在千级以内</li>
<li>key必须为int类型</li>
</ul>
<p>这样，把HashMap替换成SparseArray比较好。</p>
<h1 id="ArrayMap"><a href="#ArrayMap" class="headerlink" title="ArrayMap"></a>ArrayMap</h1><p>ArrayMap是一个<key,value>映射的map数据结构，SparseArray是数组结构，基本和SparseArray一样。</key,value></p>
<p>ArrayMap应用场景</p>
<p>满足下面两个条件我们可以使用ArrayMap代替HashMap：</p>
<ul>
<li>数据量不大，最好在千级以内</li>
<li>数据结构类型为Map类型</li>
</ul>
<p>注意这个类在API 19之后才能用，若要兼容之前版本，需要导包：</p>
<p>import android.support.v4.util.ArrayMap;</p>
<p>总结：</p>
<p>SparseArray 和 ArrayMap 如何选择？</p>
<p>假设数据量都在千级以内的情况下：</p>
<p>1、如果key的数据类型确定为int类型，那么使用SparseArray，因为它避免了自动装箱，如果key为long，它还提供了一个LongSparseArray来确保key为long类型时的使用</p>
<p>2、如果key类型为其它的类型，则使用ArrayMap</p>

          <!-- <br>
<p>SmartNi</p>
<p><img src='/images/scribble3.png' alt='scribble'></p>
 -->
        </section>
      </div>
      
      <!-- <div class='block'>
  
    <a class='main' href='/'>Home</a>
  
    <a class='main' href='/about'>About</a>
  
    <a class='main' href='mailto:nijun717@gmail.com'>Email</a>
  
    <a class='main' href='https://github.com/SmartNJ'>Github</a>
  
</div>
 -->
    </div>
    <footer>
  <span class='muted' style="font-size:17px">Powered by SmartNi</span><br>
</footer>

  </body>
</html>
