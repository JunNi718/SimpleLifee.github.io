<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Android 异步消息处理机制（一） | SmartNi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="两个问题： ​    1、在子线程中如何创建的Handler？需要先做什么？如何发送消息？ ​    2、Handler中发送的消息去哪啦？为什么handleMessage中又能得到这个Message？">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 异步消息处理机制（一）">
<meta property="og:url" content="http://nijun.me/2017/06/14/Android-2017-06-14-Android异步消息处理机制（一）/index.html">
<meta property="og:site_name" content="SmartNi">
<meta property="og:description" content="两个问题： ​    1、在子线程中如何创建的Handler？需要先做什么？如何发送消息？ ​    2、Handler中发送的消息去哪啦？为什么handleMessage中又能得到这个Message？">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-07-29T14:26:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 异步消息处理机制（一）">
<meta name="twitter:description" content="两个问题： ​    1、在子线程中如何创建的Handler？需要先做什么？如何发送消息？ ​    2、Handler中发送的消息去哪啦？为什么handleMessage中又能得到这个Message？">
  
    <link rel="alternate" href="/atom.xml" title="SmartNi" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/squirrel.png">
  
  <link rel="stylesheet" href="/css/typing.css">
</head>

  
    
      <body>
    
  
      <div id="container" class="container">
        
<article id="post-Android-2017-06-14-Android异步消息处理机制（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">
        Home
      </a>
      
      <a class="main-nav-link" href="/archives">
        Archives
      </a>
      
      <a class="main-nav-link" href="/programming">
        Programming
      </a>
      
      <a class="main-nav-link" href="/categories">
        Categories
      </a>
      
      <a class="main-nav-link" href="/resume">
        Resume
      </a>
      
      <a class="main-nav-link" href="/about">
        About
      </a>
      
      <a class="main-nav-link" href="/blog">
        Blog
      </a>
      
  </nav>
  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/mono-blue.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <!-- gruvbox-dark  ,monokai-sublime,zenburn -->
  <!-- railscasts   mono-blue  tomorrow  androidstudio  monokai-->
  <script>
  hljs.initHighlightingOnLoad();

  </script>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
      
        <br/>
        <p id="text"> </p>
        <div class="descriptionwrapper">
          <p class="description"> </p>
        </div>
  </nav>
</header>

  <hr/>
  <div class="widget widget-search">
  <form class="navbar-form navbar-right" id="search" onsubmit="search(event);return false;" _lpchecked="1">
    <div class="input-group">
    <span class="input-group-addon" id="searchIcon" onclick="search(event);"><i class="fa fa-search"></i></span>
    <input type="text" style="font-family: 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;color:#6D7569;outline-color:#c05b4d;" placeholder="Search" id="searchInput" class="form-control" value="">
    </div>
  </form>
</div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android 异步消息处理机制（一）
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">

<!--  -->

   <!-- 目录内容 -->
             
        <!-- 目录内容结束 -->



      
        <p>两个问题：</p>
<p>​    1、在子线程中如何创建的Handler？需要先做什么？如何发送消息？</p>
<p>​    2、Handler中发送的消息去哪啦？为什么handleMessage中又能得到这个Message？</p>
<a id="more"></a>
<p><strong>首先明确</strong>：网络请求必须在子线程中执行，不然会出 <code>NetworkOnMainThreadException</code> 异常。</p>
<p>参考自<a href="http://blog.csdn.net/guolin_blog" target="_blank" rel="external">郭霖</a>的 <a href="http://blog.csdn.net/guolin_blog/article/details/9991569" target="_blank" rel="external">android 异步消息处理机制</a></p>
<h1 id="一、如何在子线程创建Headler"><a href="#一、如何在子线程创建Headler" class="headerlink" title="一、如何在子线程创建Headler"></a>一、如何在子线程创建Headler</h1><p>首先我们想在子线程中创建一个Handler。（注意是在子线程中）</p>
<p>在Handler的构造函数中会调用Looper.myLooper() 得到当前的线程的Looper对象，如果没有的话就会报 ” Can’t create handler inside thread that has not called Looper.prepare().“ 这个错误。</p>
<p>prepare() 会先判断sThreadLocal.get() 这个方法从当前线程得到Looper的对象是否为空，如果为空就创建一个，不为空会报“Only one Looper may be created per thread”错误。</p>
<p>ActivityThread的main()方法中，会调用 Looper.prapareMainLooper方法，这其中又会调用  Looper.prepare() 方法，因此主线程中始终有一个Looper对象。</p>
<p>总结一下，普通线程必须先调用Looper.prepare()，然后才能创建Handler对象，</p>
<h1 id="二、Headler发送消息源码解析"><a href="#二、Headler发送消息源码解析" class="headerlink" title="二、Headler发送消息源码解析"></a>二、Headler发送消息源码解析</h1><p>创建完Handler之后，只要用把 bundle 放到 Message 中，并且再把 message放到 handler 发送即可。但是这里 Handler 把消息发送到哪里，为什么在 handleMessage 又能得到这个 Message 呢。</p>
<p>除了sendMessageAtFrontOfQueue之外，其他发送消息的方法都会辗转到sendMessageAtTime()中。而入队操作就是在这个sendMessageAtTime() 方法中。</p>
<p>Looper.loop()中包含出队操作，这个方法会一直等待新的消息入队，不然就会进入阻塞状态。每当又一个消息出队 queue.next() ，那就会调用当前handler的dispatchMessage()方法。在dispatchMessage() 方法里就会调用 handleMessage(msg)，这样我们在handleMessage就可以得到这个Message了。</p>
<p>MessageQueue 在 Looper 的构造函数中创建，那么一个 Looper 对应了一个 MessageQueue。</p>
<p>一个最标准的异步消息处理线程的写法应该是这样：</p>
<pre><code class="java">class LooperThread extends Thread {  
      public Handler mHandler;  

      public void run() {  
          //先调用Looper.prepare()方法，也就是说必须要有一个 looper 对象。
          Looper.prepare();  

          mHandler = new Handler() {  
              public void handleMessage(Message msg) {  
                  // process incoming messages here  
              }  
          };  
            //调用之后就会一直在MessageQueue中循环遍历Message，如果没有新的消息，就会挂起。
          Looper.loop();  
      }  
  }
</code></pre>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/06/14/Android-2017-06-14-Android异步消息处理机制（一）/" class="article-date">
  <time datetime="2017-06-14T02:37:55.000Z" itemprop="datePublished">2017-06-14</time>
</a>

        </li>
        
          <li>
            <span class="label">Category:</span>
            
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>


          </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2017/07/13/00001-Database-2017-07-13-20bastdatabase/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          20 个数据库设计的最佳实践
        
      </div>
    </a>
  
  
    <a href="/2017/06/14/Android-2017-06-14-Android消息处理机制之二：消息中obtain源代码剖析/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Android 消息处理机制之二：消息中 obtain 源代码剖析</div>
    </a>
  
</nav>


  
</article>




      </div>
      
    <footer id="footer" class="post-footer footer">
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>It’s not about making one choice and being done with it. It’s about continuous learning and sometimes, bold choices.</p>


      </div>
    </footer>

      

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-102765380-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->





    </div>
  </body>
</html>
